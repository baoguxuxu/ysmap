<!DOCTYPE html>
<html>
<head>
<title>确认订单</title>
<#include "/header.html">
<script type="text/javascript" src="/statics/js/libs/oauth2_token_listener.js"></script>
<script type="text/javascript" src="/statics/plugins/picker/city.js"></script>
<script type="text/javascript" src="/statics/plugins/picker/picker.min.js"></script>
<script type="text/javascript" src="/statics/plugins/picker/setup.js"></script>
</head>
<body>
<div class="Top"><span></span>确认订单</div>
<!--地址确认-->
<div class="dizhi-ok bg-white font-26">
	<a href="javascript:$.go('/account/address.html',3)">
	<p>收货人：<span class="consignee"></span> <span class="mobile"></span></p>
    <p>收货地址：<span class="addressA"></span></p>
    </a>
</div>
<!--商品确认-->
<div class="dingdan-txt bg-white font-24">
</div>
<!--发票-->
<div class="fap-ok bg-white font-26">
	<p class="fl pa"><input type="checkbox"/>发票</p>
    <div class="fr">
        <p class="pb">发票抬头：<input type="text" name="invoiceTitle"></p>
        <p class="pc">
            发票内容：
            <select name="invoiceType">
              <option value ="1">明细</option>
              <option value ="2">日用品</option>
              <option value ="3">家居用品</option>
            </select>
        </p>
    </div>
</div>
<!---->
<div class="tt-ok bg-white font-26">
	<p><span>订单金额：</span><em class="orderMoney">0.00</em></p>
    <p><span>运费：</span><em>0.00</em></p>
    <p><em>小计：<i class="totalMoney">0.00</i></em></p>
</div>

<div class="gouwuche-buy bg-white font-26 qian-ok">
    <p>合计金额：<i>￥<em class="totalMoney">0.00</em></i></p>
    <a href="javascript:void(0);" class="confirmBtn">确认</a>
</div>
<script type="text/javascript">
$(function(){
	var orderNo = url("orderNo");
	var pickerSetup = new PickerSetup({
    	selected: [0,0,0],
		title: "请选择地区",
		onSelected: function(selected,text){
			$(".addressSelected").html(text.toString().replace(new RegExp(",","gm")," "));
			areaCode = selected.toString();
		}
	});
	$.ajax({
		url: "/account/address/defaultUse",
		success: function(r){
			console.info(r);
			if(r.errcode == 0){
				var address = r.data;
				var d = pickerSetup.getCityByCode(r.data.areaCode.split(","));
				console.info(d);
				$(".dizhi-ok .consignee").text(address.consignee);
				$(".dizhi-ok .mobile").text(address.mobile);
				$(".dizhi-ok .addressA").text(d.toString().replace(new RegExp(",","gm"),"")+address.address);
				$(".confirmBtn").click(function(){
					if(!login.isLogin()){
						window.location.href = loginCallUri();
						return;
					}
					var invoiceType = $("select[name=invoiceType]").val(),
					invoiceTitle = $("input[name=invoiceTitle]").val(),
					address = $(".dizhi-ok .addressA").text(),
					consignee = $(".dizhi-ok .consignee").text(),
					mobile = $(".dizhi-ok .mobile").text();
					var orderset = {
						orderNo: orderNo,
						invoiceType: invoiceType ,
						invoiceTitle: invoiceTitle,
						address: address,
						consignee: consignee,
						mobile: mobile
					};
					$.ajax({
						url: "/mall/order/confirmOrder",
						type: "POST",
						data: orderset,
						success: function(r){
							if(r.errcode == '0'){
								window.location.href = "/order/mylist.html";
							}
						}
					});
				});
			}
		}
	});
	
	$.ajax({
		url: "/mall/order/nopay",
		data: {orderNo:orderNo},
		success: function(r){
			
			if(r.errcode == '0'){
				if(!r.data || r.data.length == 0){
					alert("订单已支付或不存在！");
					return;
				}
				var html = "";
				for(var i=0;i<r.data.childs.length;i++){
					html += '<dl style="background:#fff;">';
					html += '    <dt><img src="'+r.data.childs[i].picImg+'" alt=""/></dt>';
					html += '    <dd>';
					html += '        <span>'+r.data.childs[i].name+'</span>';
					html += '        <i>'+r.data.childs[i].productSpecName+'</i>';
					html += '    </dd>';
					html += '     <em>&times; '+r.data.childs[i].buyNumber+'</em>';
					html += ' </dl>';
				}
				$(".dingdan-txt").html(html);
				$(".orderMoney").text(r.data.payAmount.toFixed(2));
				$(".totalMoney").text(r.data.payAmount.toFixed(2));
			}
		}
	});
	
});
</script>
</body>
</html>
